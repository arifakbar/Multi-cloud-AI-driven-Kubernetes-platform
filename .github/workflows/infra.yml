name: Multi-Cloud Infrastructure Deployment

on:
  workflow_dispatch:
    inputs:
      cloud:
        description: 'Which cloud to deploy?'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - azure
          - aws

permissions:
  id-token: write
  contents: read

env:
  # Azure
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_USE_OIDC: true
  AWS_REGION: us-east-1

jobs:

  # ----------------------------
  # Azure Terraform Plan
  # ----------------------------
  terraform-plan-azure:
    name: Terraform Plan (Azure)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'azure' }}
    defaults:
      run:
        working-directory: terraform/azure
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Terraform Init
        run: terraform init
      - name: Terraform Plan
        run: terraform plan -out=tfplan
      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: azure-tfplan
          path: terraform/azure/tfplan

  # ----------------------------
  # AWS Terraform Plan
  # ----------------------------
  terraform-plan-aws:
    name: Terraform Plan (AWS)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'aws' }}
    defaults:
      run:
        working-directory: terraform/aws
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::007222077088:role/Github-Actions
          aws-region: ${{ env.AWS_REGION }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Terraform Init
        run: terraform init
      - name: Terraform Plan
        run: terraform plan -out=tfplan
      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: aws-tfplan
          path: terraform/aws/tfplan

  # ----------------------------
  # Terraform Apply (Hybrid)
  # ----------------------------
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan-azure, terraform-plan-aws]
    if: ${{ github.event_name == 'workflow_dispatch' }}
    environment: Apply # Approval gate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------
      # Apply Azure
      # ----------------------------
      - name: Azure Login
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'azure' }}
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Setup Terraform (Azure)
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'azure' }}
        uses: hashicorp/setup-terraform@v3
      - name: Download Azure Plan Artifact
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'azure' }}
        uses: actions/download-artifact@v4
        with:
          name: azure-tfplan
          path: terraform/azure
      - name: Terraform Apply (Azure)
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'azure' }}
        run: |
          cd terraform/azure
          terraform apply -auto-approve tfplan

      # ----------------------------
      # Apply AWS
      # ----------------------------
      - name: Configure AWS Credentials via OIDC
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'aws' }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::007222077088:role/Github-Actions
          aws-region: ${{ env.AWS_REGION }}
      - name: Setup Terraform (AWS)
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'aws' }}
        uses: hashicorp/setup-terraform@v3
      - name: Download AWS Plan Artifact
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'aws' }}
        uses: actions/download-artifact@v4
        with:
          name: aws-tfplan
          path: terraform/aws
      - name: Terraform Apply (AWS)
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'aws' }}
        run: |
          cd terraform/aws
          terraform apply -auto-approve tfplan