name: Multi-Cloud Infrastructure Deployment

on:
  workflow_dispatch:
    inputs:
      cloud:
        description: 'Which cloud to deploy?'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - azure
          - aws

permissions:
  id-token: write
  contents: read

env:
  # Azure
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_USE_OIDC: true
  # AWS
  AWS_REGION: us-east-1

# ----------------------------
# Azure Terraform Plan
# ----------------------------
jobs:
  terraform-plan-azure:
    name: Terraform Plan (Azure)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'azure' }}
    defaults:
      run:
        working-directory: terraform/azure
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Terraform Init
        run: terraform init
      - name: Terraform Plan
        run: terraform plan -out=tfplan
      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: azure-tfplan
          path: terraform/azure/tfplan

# ----------------------------
# AWS Terraform Plan
# ----------------------------
  terraform-plan-aws:
    name: Terraform Plan (AWS)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'aws' }}
    defaults:
      run:
        working-directory: terraform/aws
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::007222077088:role/Github-Actions
          aws-region: ${{ env.AWS_REGION }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Terraform Init
        run: terraform init
      - name: Terraform Plan
        run: terraform plan -out=tfplan
      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: aws-tfplan
          path: terraform/aws/tfplan

# ----------------------------
# Azure Apply
# ----------------------------
  terraform-apply-azure:
    name: Terraform Apply (Azure)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'azure' }}
    needs: terraform-plan-azure
    environment: Apply # Approval gate
    defaults:
      run:
        working-directory: terraform/azure
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: azure-tfplan
          path: terraform/azure
      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

# ----------------------------
# AWS Apply
# ----------------------------
  terraform-apply-aws:
    name: Terraform Apply (AWS)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'aws' }}
    needs: terraform-plan-aws
    environment: Apply # Approval gate
    defaults:
      run:
        working-directory: terraform/aws
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::007222077088:role/Github-Actions
          aws-region: ${{ env.AWS_REGION }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: aws-tfplan
          path: terraform/aws
      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan