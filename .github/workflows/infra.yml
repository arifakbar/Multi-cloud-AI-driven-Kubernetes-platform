name: Multi-Cloud Terraform

on:
  workflow_dispatch:
    inputs:
      cloud:
        description: 'Which cloud to deploy?'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - azure
          - aws

jobs:

  # ----------------------------
  # Azure Plan
  # ----------------------------
  azure-plan:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'azure' }}
    steps:
      - uses: actions/checkout@v3
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZ_CLIENT_ID }}
          tenant-id: ${{ secrets.AZ_TENANT_ID }}
          subscription-id: ${{ secrets.AZ_SUBSCRIPTION_ID }}
      - name: Terraform Init & Plan (Azure)
        run: |
          cd terraform/azure
          terraform init
          terraform plan -out=tfplan
      - name: Upload Azure Plan Artifact
        uses: actions/upload-artifact@v3
        with:
          name: azure-tfplan
          path: terraform/azure/tfplan

  # ----------------------------
  # AWS Plan
  # ----------------------------
  aws-plan:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'aws' }}
    steps:
      - uses: actions/checkout@v3
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::007222077088:role/Github-Actions
          aws-region: us-east-1
      - name: Terraform Init & Plan (AWS)
        run: |
          cd terraform/aws
          terraform init
          terraform plan -out=tfplan
      - name: Upload AWS Plan Artifact
        uses: actions/upload-artifact@v3
        with:
          name: aws-tfplan
          path: terraform/aws/tfplan

  # ----------------------------
  # Apply
  # ----------------------------
  apply:
    runs-on: ubuntu-latest
    needs: [azure-plan, aws-plan]
    if: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - uses: actions/checkout@v3

      - name: Manual Approval
        uses: hmarr/auto-approve-action@v2
        with:
          comment: "Terraform apply approved"

      # ----------------------------
      # Apply Azure
      # ----------------------------
      - name: Azure Login
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'azure' }}
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZ_CLIENT_ID }}
          tenant-id: ${{ secrets.AZ_TENANT_ID }}
          subscription-id: ${{ secrets.AZ_SUBSCRIPTION_ID }}

      - name: Download Azure Plan Artifact
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'azure' }}
        uses: actions/download-artifact@v3
        with:
          name: azure-tfplan
          path: terraform/azure

      - name: Terraform Apply (Azure)
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'azure' }}
        run: |
          cd terraform/azure
          terraform apply -auto-approve tfplan

      # ----------------------------
      # Apply AWS
      # ----------------------------
      - name: Configure AWS Credentials via OIDC
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'aws' }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::007222077088:role/Github-Actions
          aws-region: us-east-1

      - name: Download AWS Plan Artifact
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'aws' }}
        uses: actions/download-artifact@v3
        with:
          name: aws-tfplan
          path: terraform/aws

      - name: Terraform Apply (AWS)
        if: ${{ github.event.inputs.cloud == 'all' || github.event.inputs.cloud == 'aws' }}
        run: |
          cd terraform/aws
          terraform apply -auto-approve tfplan